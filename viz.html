<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Starscrape — Starlink Pass Visualization</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
  /* ── Reset & base ──────────────────────────────────────────────────── */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: system-ui, -apple-system, sans-serif;
    background: #0d1b2a;
    color: #cfd8dc;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* ── Header ────────────────────────────────────────────────────────── */
  #header {
    height: 48px;
    flex-shrink: 0;
    background: #0f2744;
    border-bottom: 1px solid #1a3a5c;
    display: flex;
    align-items: center;
    gap: 0;
    padding: 0 16px;
    overflow: hidden;
  }
  #header h1 {
    font-size: 15px;
    font-weight: 700;
    color: #64b5f6;
    letter-spacing: 0.5px;
    flex-shrink: 0;
    margin-right: 16px;
  }
  .h-sep { width: 1px; height: 22px; background: #1e3a5f; flex-shrink: 0; margin: 0 14px; }
  #stats-panel {
    display: flex;
    align-items: center;
    gap: 0;
    flex: 1;
    overflow: hidden;
  }
  .stat-chip {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 12.5px;
    padding: 0 12px;
    border-right: 1px solid #1a3a5c;
    height: 48px;
    flex-shrink: 0;
  }
  .stat-chip:last-child { border-right: none; }
  .stat-label { color: #607d8b; }
  .stat-value { font-weight: 600; }
  .c-likely   { color: #66bb6a; }
  .c-marginal { color: #ffa726; }
  .c-obs      { color: #42a5f5; }
  .c-cov      { color: #ab47bc; }

  /* ── Map ───────────────────────────────────────────────────────────── */
  #map { flex: 1; min-height: 0; }

  /* ── Controls ──────────────────────────────────────────────────────── */
  #controls {
    height: 50px;
    flex-shrink: 0;
    background: #101e2e;
    border-top: 1px solid #1a3a5c;
    border-bottom: 1px solid #1a3a5c;
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 0 14px;
  }
  #play-btn {
    background: #1565c0;
    border: none;
    color: #fff;
    padding: 6px 18px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    min-width: 84px;
    flex-shrink: 0;
    transition: background 0.15s;
  }
  #play-btn:hover { background: #1976d2; }
  #speed-select {
    background: #0f2744;
    border: 1px solid #1a3a5c;
    color: #cfd8dc;
    padding: 5px 8px;
    border-radius: 4px;
    font-size: 12px;
    flex-shrink: 0;
    cursor: pointer;
  }
  #scrubber {
    flex: 1;
    accent-color: #42a5f5;
    cursor: pointer;
    min-width: 0;
  }
  #time-display {
    font-size: 12.5px;
    color: #90caf9;
    font-variant-numeric: tabular-nums;
    flex-shrink: 0;
    min-width: 175px;
    text-align: right;
  }

  /* ── Timeline ──────────────────────────────────────────────────────── */
  #tl-wrap {
    flex-shrink: 0;
    background: #0a1520;
    padding: 6px 14px 8px;
  }
  #tl-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: #455a64;
    margin-bottom: 4px;
  }
  #tl-outer {
    position: relative;
    height: 40px;
    border-radius: 4px;
    overflow: hidden;
    background: #1a2a3a;
  }
  /* blocks appended as absolutely-positioned children */
  .tl-block {
    position: absolute;
    top: 0;
    height: 100%;
    cursor: pointer;
    transition: filter 0.1s;
  }
  .tl-block:hover { filter: brightness(1.3); }
  #tl-cursor {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 2px;
    background: rgba(255,255,255,0.9);
    pointer-events: none;
    z-index: 10;
    box-shadow: 0 0 6px rgba(255,255,255,0.5);
    transition: left 0.05s linear;
  }

  /* ── Legend ────────────────────────────────────────────────────────── */
  #legend {
    flex-shrink: 0;
    height: 28px;
    background: #0a1520;
    border-top: 1px solid #1a3a5c;
    display: flex;
    align-items: center;
    gap: 18px;
    padding: 0 14px;
  }
  .leg-item { display: flex; align-items: center; gap: 5px; font-size: 11px; color: #78909c; }
  .leg-dot  { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; }
  .leg-rect { width: 13px; height: 9px; border-radius: 2px; flex-shrink: 0; }

  /* ── Floating tooltip ──────────────────────────────────────────────── */
  #tooltip {
    position: fixed;
    background: rgba(8, 18, 32, 0.97);
    color: #cfd8dc;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 12px;
    line-height: 1.65;
    pointer-events: none;
    display: none;
    z-index: 9000;
    max-width: 260px;
    white-space: pre-line;
    border: 1px solid #1565c0;
    box-shadow: 0 4px 16px rgba(0,0,0,0.5);
  }

  /* ── Error overlay ─────────────────────────────────────────────────── */
  #error-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 8000;
    align-items: center;
    justify-content: center;
  }
  #error-overlay.visible { display: flex; }
  #error-box {
    background: #1a0a0a;
    border: 1px solid #b71c1c;
    border-radius: 10px;
    padding: 28px 32px;
    max-width: 440px;
    text-align: center;
  }
  #error-box h2 { color: #ef5350; margin-bottom: 10px; font-size: 18px; }
  #error-box p  { font-size: 13px; color: #90a4ae; line-height: 1.6; }
  #error-box code {
    display: inline-block;
    background: rgba(255,255,255,0.07);
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 12.5px;
    margin: 6px 0;
    color: #80cbc4;
  }

  /* Leaflet popup overrides */
  .leaflet-popup-content { font-size: 13px; line-height: 1.6; min-width: 180px; }
  .leaflet-popup-content b { color: #1565c0; }
</style>
</head>
<body>

<!-- Header -->
<div id="header">
  <h1>Starscrape</h1>
  <div class="h-sep"></div>
  <div id="stats-panel">
    <div class="stat-chip">
      <span class="stat-label">Observer</span>
      <span id="s-obs" class="stat-value c-obs">—</span>
    </div>
    <div class="stat-chip">
      <span class="stat-label">In-beam</span>
      <span id="s-likely" class="stat-value c-likely">—</span>
    </div>
    <div class="stat-chip">
      <span class="stat-label">Marginal</span>
      <span id="s-marginal" class="stat-value c-marginal">—</span>
    </div>
    <div class="stat-chip">
      <span class="stat-label">Best el</span>
      <span id="s-el" class="stat-value">—</span>
    </div>
    <div class="stat-chip">
      <span class="stat-label">Coverage</span>
      <span id="s-cov" class="stat-value c-cov">—</span>
    </div>
    <div class="stat-chip">
      <span class="stat-label">Avg in-beam</span>
      <span id="s-avg" class="stat-value">—</span>
    </div>
  </div>
</div>

<!-- Leaflet map -->
<div id="map"></div>

<!-- Playback controls -->
<div id="controls">
  <button id="play-btn">&#9654; Play</button>
  <select id="speed-select" title="Playback speed">
    <option value="500">&#189;&times;</option>
    <option value="200" selected>1&times;</option>
    <option value="50">4&times;</option>
    <option value="15">16&times;</option>
  </select>
  <input type="range" id="scrubber" min="0" value="0" step="1">
  <div id="time-display">—</div>
</div>

<!-- Timeline -->
<div id="tl-wrap">
  <div id="tl-label">Handoff Schedule</div>
  <div id="tl-outer">
    <!-- blocks injected by JS -->
    <div id="tl-cursor"></div>
  </div>
</div>

<!-- Legend -->
<div id="legend">
  <div class="leg-item"><div class="leg-dot" style="background:#66bb6a"></div> Likely (in beam)</div>
  <div class="leg-item"><div class="leg-dot" style="background:#ffa726"></div> Marginal</div>
  <div class="leg-item"><div class="leg-rect" style="background:#c62828"></div> Coverage gap</div>
  <div class="leg-item"><div class="leg-rect" style="background:#37474f;border:1px solid #607d8b"></div> Marginal gap fill</div>
  <div class="leg-item" style="margin-left:auto;color:#455a64;font-size:10.5px">
    Click timeline to jump &nbsp;|&nbsp; Click sat dot for details &nbsp;|&nbsp; Space = play/pause
  </div>
</div>

<!-- Floating tooltip -->
<div id="tooltip"></div>

<!-- Error overlay -->
<div id="error-overlay">
  <div id="error-box">
    <h2>Cannot load viz_data.json</h2>
    <p>Generate it first, then serve this directory:</p>
    <code>python main.py --lat &hellip; --lon &hellip; --viz</code>
    <br>
    <code>python -m http.server 8000</code>
    <p style="margin-top:10px">Then open &nbsp;<code>http://localhost:8000/viz.html</code></p>
    <p style="margin-top:14px;font-size:11px">
      Zero-server: replace <code>window.VIZ_DATA = null</code> in this file
      with <code>window.VIZ_DATA = &lt;contents of viz_data.json&gt;;</code>
    </p>
  </div>
</div>

<!--
  EMBEDDED DATA — for zero-server use:
  Replace null below with the full contents of viz_data.json.
  The page will use this if fetch('viz_data.json') fails.
-->
<script>window.VIZ_DATA = null;</script>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
'use strict';

// ── State ───────────────────────────────────────────────────────────────────
let data        = null;   // parsed viz_data.json
let satsByStep  = {};     // step_idx (int) → [{sat info + position}]
let currentStep = 0;
let playing     = false;
let playTimer   = null;
const satMarkers = {};    // norad_id (int) → L.CircleMarker
let map         = null;
const tooltip   = document.getElementById('tooltip');

// ── Load data (fetch → embedded fallback) ────────────────────────────────────
async function loadData() {
  if (window.VIZ_DATA !== null) return window.VIZ_DATA;
  const r = await fetch('viz_data.json');
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

// ── Pre-compute per-step lookup ──────────────────────────────────────────────
function buildLookup() {
  satsByStep = {};
  for (const traj of data.trajectories) {
    for (const pt of traj.points) {
      let arr = satsByStep[pt.ti];
      if (!arr) { arr = []; satsByStep[pt.ti] = arr; }
      arr.push({
        sat_name:       traj.sat_name,
        norad_id:       traj.norad_id,
        link:           traj.link,
        shell:          traj.shell,
        orbital_alt_km: traj.orbital_alt_km,
        link_note:      traj.link_note,
        lat:   pt.lat,
        lon:   pt.lon,
        el:    pt.el,
        az:    pt.az,
        slant: pt.slant,
      });
    }
  }
}

// ── Map setup ────────────────────────────────────────────────────────────────
function setupMap() {
  const { lat, lon } = data.observer;
  map = L.map('map', { preferCanvas: true }).setView([lat, lon], 5);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    maxZoom: 19,
  }).addTo(map);

  // Observer marker
  const obsIcon = L.divIcon({
    html: '<div style="width:14px;height:14px;background:#42a5f5;border:2.5px solid #fff;border-radius:50%;box-shadow:0 0 8px rgba(66,165,245,0.7)"></div>',
    className: '',
    iconAnchor: [7, 7],
  });
  L.marker([lat, lon], { icon: obsIcon, zIndexOffset: 1000 })
    .bindPopup(`<b>Observer</b><br>${lat.toFixed(4)}&deg;N,&nbsp;${lon.toFixed(4)}&deg;E`)
    .addTo(map);
}

// ── Update satellite markers for the current step ────────────────────────────
function updateMap(step) {
  const sats       = satsByStep[step] || [];
  const visibleIds = new Set(sats.map(s => s.norad_id));

  // Remove markers that are no longer visible
  for (const idStr of Object.keys(satMarkers)) {
    const id = Number(idStr);
    if (!visibleIds.has(id)) {
      map.removeLayer(satMarkers[id]);
      delete satMarkers[id];
    }
  }

  // Add / update markers
  for (const sat of sats) {
    const color = sat.link === 'likely' ? '#66bb6a' : '#ffa726';
    const pos   = [sat.lat, sat.lon];

    if (satMarkers[sat.norad_id]) {
      satMarkers[sat.norad_id]
        .setLatLng(pos)
        .setStyle({ color, fillColor: color });
    } else {
      const m = L.circleMarker(pos, {
        radius:      6,
        color:       color,
        fillColor:   color,
        fillOpacity: 0.85,
        weight:      1.5,
      });
      // Bind popup with satellite details (evaluated lazily on click)
      m.bindPopup(() => {
        return (
          `<b>${sat.sat_name}</b><br>` +
          `NORAD: ${sat.norad_id}<br>` +
          `El: ${sat.el}&deg;&nbsp;&nbsp;Az: ${sat.az}&deg;<br>` +
          `Slant: ${sat.slant}&thinsp;km<br>` +
          `Alt: ${sat.orbital_alt_km}&thinsp;km &mdash; ${sat.shell}<br>` +
          `Link: <b style="color:${color}">${sat.link}</b><br>` +
          `<small style="color:#90a4ae">${sat.link_note}</small>`
        );
      });
      satMarkers[sat.norad_id] = m;
      m.addTo(map);
    }
  }
}

// ── Update header stats ──────────────────────────────────────────────────────
function updateStats(step) {
  const ts = data.timesteps[step];
  document.getElementById('s-likely').textContent   = ts.n_likely;
  document.getElementById('s-marginal').textContent = ts.n_marginal;
  document.getElementById('s-el').textContent       = ts.best_el !== null ? ts.best_el + '\u00b0' : '\u2014';
  document.getElementById('time-display').textContent = fmtStep(step);
}

// ── Render timeline ──────────────────────────────────────────────────────────
function renderTimeline() {
  const outer    = document.getElementById('tl-outer');
  const cursor   = document.getElementById('tl-cursor');
  const startMs  = Date.parse(data.window_start);
  const windowMs = Date.parse(data.window_end) - startMs;

  for (const entry of data.handoff_schedule) {
    const entryStartMs = Date.parse(entry.start) - startMs;
    const entryDurMs   = Date.parse(entry.end) - Date.parse(entry.start);
    const leftPct      = entryStartMs / windowMs * 100;
    const widthPct     = entryDurMs   / windowMs * 100;
    if (widthPct < 0.02) continue;  // skip sub-pixel sliver

    const block = document.createElement('div');
    block.className        = 'tl-block';
    block.style.left       = leftPct  + '%';
    block.style.width      = widthPct + '%';

    let bg, tipLines;
    if (entry.is_gap) {
      bg = '#c62828';
      tipLines = [
        'COVERAGE GAP',
        fmtDur(entry.duration_min),
        fmtUTC(entry.start) + ' \u2013 ' + fmtUTC(entry.end),
      ];
    } else if (entry.is_marginal_fill) {
      bg = '#37474f';
      tipLines = [
        entry.sat_name + '  (marginal gap fill)',
        'NORAD: ' + entry.norad_id,
        'Peak: ' + entry.peak_el_deg + '\u00b0  \u2022  ' + entry.shell,
        fmtDur(entry.duration_min),
        fmtUTC(entry.start) + ' \u2013 ' + fmtUTC(entry.end),
      ];
    } else {
      bg = satColor(entry.norad_id);
      tipLines = [
        entry.sat_name,
        'NORAD: ' + entry.norad_id,
        'Peak: ' + entry.peak_el_deg + '\u00b0  \u2022  ' + entry.shell,
        fmtDur(entry.duration_min),
        fmtUTC(entry.start) + ' \u2013 ' + fmtUTC(entry.end),
      ];
    }
    block.style.background = bg;

    const tipText = tipLines.join('\n');
    block.addEventListener('mousemove', e => {
      tooltip.style.left    = (e.clientX + 14) + 'px';
      tooltip.style.top     = (e.clientY + 14) + 'px';
      tooltip.style.display = 'block';
      tooltip.textContent   = tipText;
    });
    block.addEventListener('mouseleave', () => {
      tooltip.style.display = 'none';
    });

    // Click → jump playback to this entry's start
    block.addEventListener('click', () => {
      const step = Math.round(entryStartMs / (data.timestep_sec * 1000));
      stepTo(Math.max(0, Math.min(data.n_steps - 1, step)));
    });

    // Insert before the cursor so cursor stays on top
    outer.insertBefore(block, cursor);
  }
}

function updateCursor(step) {
  const pct = step / Math.max(1, data.n_steps - 1) * 100;
  document.getElementById('tl-cursor').style.left = pct + '%';
}

// ── Controls setup ───────────────────────────────────────────────────────────
function setupControls() {
  const { lat, lon } = data.observer;
  const latStr = (lat >= 0 ? lat.toFixed(3) + '\u00b0N' : (-lat).toFixed(3) + '\u00b0S');
  const lonStr = (lon >= 0 ? lon.toFixed(3) + '\u00b0E' : (-lon).toFixed(3) + '\u00b0W');
  document.getElementById('s-obs').textContent = latStr + ', ' + lonStr;
  document.getElementById('s-cov').textContent = data.summary.coverage_pct + '%';
  document.getElementById('s-avg').textContent =
    data.summary.avg_sats_in_footprint + ' (peak ' + data.summary.peak_simultaneous + ')';

  const scrubber = document.getElementById('scrubber');
  scrubber.max   = data.n_steps - 1;
  scrubber.addEventListener('input', () => stepTo(Number(scrubber.value)));

  document.getElementById('play-btn').addEventListener('click', playPause);
  document.getElementById('speed-select').addEventListener('change', () => {
    if (playing) { clearInterval(playTimer); startPlay(); }
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', e => {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
    if (e.code === 'Space')       { e.preventDefault(); playPause(); }
    if (e.code === 'ArrowRight')  { e.preventDefault(); stepTo(Math.min(data.n_steps - 1, currentStep + 1)); }
    if (e.code === 'ArrowLeft')   { e.preventDefault(); stepTo(Math.max(0, currentStep - 1)); }
  });
}

// ── Step controls ────────────────────────────────────────────────────────────
function stepTo(step) {
  currentStep = step;
  document.getElementById('scrubber').value = step;
  updateMap(step);
  updateStats(step);
  updateCursor(step);
}

function playPause() {
  if (playing) {
    clearInterval(playTimer);
    playing = false;
    document.getElementById('play-btn').innerHTML = '&#9654; Play';
  } else {
    if (currentStep >= data.n_steps - 1) stepTo(0);
    startPlay();
  }
}

function startPlay() {
  playing = true;
  document.getElementById('play-btn').innerHTML = '&#9646;&#9646; Pause';
  const interval = Number(document.getElementById('speed-select').value);
  playTimer = setInterval(() => {
    if (currentStep >= data.n_steps - 1) {
      clearInterval(playTimer);
      playing = false;
      document.getElementById('play-btn').innerHTML = '&#9654; Play';
      return;
    }
    stepTo(currentStep + 1);
  }, interval);
}

// ── Utilities ─────────────────────────────────────────────────────────────────
function fmtStep(step) {
  const ms = Date.parse(data.window_start) + step * data.timestep_sec * 1000;
  return new Date(ms).toISOString().slice(0, 16).replace('T', ' ') + ' UTC';
}

function fmtUTC(iso) {
  return iso.slice(0, 16).replace('T', ' ') + ' UTC';
}

function fmtDur(min) {
  const h = Math.floor(min / 60);
  const m = Math.round(min % 60);
  return h > 0 ? h + 'h\u202f' + m + 'min' : m + 'min';
}

// Stable per-satellite color using golden-angle hue distribution.
// Same norad_id always maps to the same color across sessions.
function satColor(norad_id) {
  const hue = (norad_id * 137) % 360;
  return `hsl(${hue},55%,45%)`;
}

// ── Bootstrap ─────────────────────────────────────────────────────────────────
loadData()
  .then(d => {
    data = d;
    buildLookup();
    setupMap();
    setupControls();
    renderTimeline();
    stepTo(0);
  })
  .catch(err => {
    console.error('starscrape viz: failed to load data:', err);
    document.getElementById('error-overlay').classList.add('visible');
  });
</script>
</body>
</html>
